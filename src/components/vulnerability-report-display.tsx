
"use client";

import type { AnalysisResult } from "@/types";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { AlertTriangle, CheckCircle2, FileText, Info, LockKeyhole, ShieldAlert, ShieldCheck, ShieldOff } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";

type VulnerabilityReportDisplayProps = {
  result: AnalysisResult | null;
};

export function VulnerabilityReportDisplay({ result }: VulnerabilityReportDisplayProps) {
  if (!result) {
    return (
      <Card className="mt-8 shadow-lg">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-xl">
            <Info className="h-6 w-6 text-primary" />
            Awaiting Analysis
          </CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground">
            Enter a URL above and click "Scan Vulnerabilities" to see the analysis report.
          </p>
        </CardContent>
      </Card>
    );
  }

  if (result.error) {
    return (
      <Card className="mt-8 border-destructive bg-destructive/10 shadow-lg">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-xl text-destructive">
            <AlertTriangle className="h-6 w-6" />
            Analysis Error
          </CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-destructive">{result.error}</p>
        </CardContent>
      </Card>
    );
  }
  
  const hasVulnerabilities = result.vulnerabilities && result.vulnerabilities.length > 0;

  const getSeverity = (isVulnerable: boolean, potentialForAccountLockout: boolean) => {
    if (isVulnerable && potentialForAccountLockout) {
      return {
        icon: <ShieldAlert className="h-5 w-5 text-destructive inline-block" />,
        badge: <Badge variant="destructive" className="ml-2">High Risk</Badge>,
        tooltip: "High risk vulnerability with potential for account lockout.",
        textColor: "text-destructive",
      };
    } else if (isVulnerable) {
      return {
        // Using accent color (orange) for medium risk
        icon: <AlertTriangle className="h-5 w-5 text-accent inline-block" />, 
        badge: <Badge variant="outline" className="ml-2 border-accent text-accent">Medium Risk</Badge>,
        tooltip: "Medium risk vulnerability detected.",
        textColor: "text-accent",
      };
    } else {
      // Using green color, acknowledging deviation from strict theme-only usage
      return {
        icon: <ShieldCheck className="h-5 w-5 text-green-600 inline-block" />, 
        badge: <Badge variant="outline" className="ml-2 border-green-500 text-green-600">Secure</Badge>,
        tooltip: "This specific check passed, considered secure in this context.",
        textColor: "text-green-600",
      };
    }
  };

  const renderIconWithTooltip = (icon: React.ReactNode, tooltipText: string) => (
    <Tooltip>
      <TooltipTrigger asChild>
        <span className="inline-flex items-center justify-center">{icon}</span>
      </TooltipTrigger>
      <TooltipContent>
        <p>{tooltipText}</p>
      </TooltipContent>
    </Tooltip>
  );

  return (
    <div className="mt-8 space-y-8">
      {result.reportText && (
        <Card className="shadow-lg">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-xl">
              <FileText className="h-6 w-6 text-primary" />
              Generated Security Report
            </CardTitle>
          </CardHeader>
          <CardContent>
            {/* Use pre-wrap to preserve formatting from the AI report */}
            <div className="prose dark:prose-invert max-w-none whitespace-pre-wrap text-foreground text-sm">
              {result.reportText}
            </div>
          </CardContent>
        </Card>
      )}

      <Card className="shadow-lg">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-xl">
            <ShieldAlert className="h-6 w-6 text-primary" />
            Detailed Vulnerability Findings
          </CardTitle>
          {!hasVulnerabilities && (
            <CardDescription>No specific vulnerabilities detected by this scan.</CardDescription>
          )}
        </CardHeader>
        {hasVulnerabilities && (
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Vulnerability</TableHead>
                  <TableHead className="text-center">Severity</TableHead>
                  <TableHead className="text-center">Detected</TableHead>
                  <TableHead className="text-center">Account Lockout Risk</TableHead>
                  <TableHead>Recommended Fix</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {result.vulnerabilities!.map((vuln, index) => {
                  const severity = getSeverity(vuln.isVulnerable, vuln.potentialForAccountLockout);
                  return (
                    <TableRow key={index} className={vuln.isVulnerable ? "bg-muted/30" : ""}>
                      <TableCell className="font-medium">{vuln.vulnerability}</TableCell>
                      <TableCell className="text-center">
                        {renderIconWithTooltip(
                          <span className={`flex items-center justify-center ${severity.textColor}`}>
                            {severity.icon}
                            {severity.badge}
                          </span>,
                          severity.tooltip
                        )}
                      </TableCell>
                       <TableCell className="text-center">
                        {vuln.isVulnerable ? (
                           renderIconWithTooltip(
                             <ShieldCheck className="h-5 w-5 text-green-600 inline-block" />, 
                             "Vulnerability Detected"
                           )
                        ) : (
                           renderIconWithTooltip(
                             <ShieldOff className="h-5 w-5 text-muted-foreground inline-block" />,
                             "Not Detected"
                           )
                        )}
                      </TableCell>
                      <TableCell className="text-center">
                        {vuln.potentialForAccountLockout ? (
                           renderIconWithTooltip(
                            <LockKeyhole className="h-5 w-5 text-destructive inline-block" />,
                            "Potential for Account Lockout"
                           )
                        ) : (
                            renderIconWithTooltip(
                              <CheckCircle2 className="h-5 w-5 text-green-600 inline-block" />,
                              "Low Risk of Account Lockout"
                            )
                        )}
                      </TableCell>
                      <TableCell className="text-sm text-muted-foreground">{vuln.remediation}</TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>
          </CardContent>
        )}
      </Card>
    </div>
  );
}
